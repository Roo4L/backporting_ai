---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { loadDigests } from "../../data/load-digests.ts";
const digests = await loadDigests();
// Minimal Markdown renderer for headings, paragraphs, and unordered lists.
// This avoids adding a new dependency while keeping digest content readable.
function escapeHtml(input: string): string {
  return input
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function renderInlineWithLinks(input: string): string {
  // Renders inline Markdown links [text](url) while escaping other HTML.
  // Only http/https links are recognized.
  const linkRe = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
  let result = '';
  let lastIndex = 0;
  let match: RegExpExecArray | null;
  while ((match = linkRe.exec(input)) !== null) {
    const [full, text, url] = match;
    const start = match.index;
    const end = start + full.length;
    // Escape and append preceding text
    result += escapeHtml(input.slice(lastIndex, start));
    // Append safe anchor
    result += `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="underline decoration-slate-300 hover:decoration-slate-500">${escapeHtml(text)}</a>`;
    lastIndex = end;
  }
  // Append the remainder
  result += escapeHtml(input.slice(lastIndex));
  return result;
}

function renderSimpleMarkdown(markdown: string): string {
  const html: string[] = [];
  const lines = markdown.replaceAll('\r\n', '\n').split('\n');

  let paragraphLines: string[] = [];
  let listItems: string[] = [];
  const flushParagraph = () => {
    if (paragraphLines.length > 0) {
      const content = paragraphLines.map((l) => renderInlineWithLinks(l)).join('<br />');
      html.push(`<p class="mt-5 text-base leading-loose">${content}</p>`);
      paragraphLines = [];
    }
  };
  const flushList = () => {
    if (listItems.length > 0) {
      const items = listItems.map((t) => `<li class="leading-loose">${renderInlineWithLinks(t)}</li>`).join('');
      html.push(`<ul class="mt-5 list-disc pl-6 space-y-2">${items}</ul>`);
      listItems = [];
    }
  };

  for (const raw of lines) {
    const line = raw.trimEnd();
    if (/^\s*$/.test(line)) {
      flushParagraph();
      flushList();
      continue;
    }
    if (line.startsWith('### ')) {
      flushParagraph();
      flushList();
      html.push(`<h3 class="mt-10 mb-4 text-xl font-semibold text-slate-900">${renderInlineWithLinks(line.slice(4).trim())}</h3>`);
      continue;
    }
    if (line.startsWith('## ')) {
      flushParagraph();
      flushList();
      html.push(`<h2 class="mt-12 mb-4 text-2xl font-semibold text-slate-900">${renderInlineWithLinks(line.slice(3).trim())}</h2>`);
      continue;
    }
    if (/^[-*]\s+/.test(line)) {
      flushParagraph();
      listItems.push(line.replace(/^[-*]\s+/, ''));
      continue;
    }
    paragraphLines.push(line);
  }
  flushParagraph();
  flushList();
  return html.join('\n');
}

export const getStaticPaths = async () => {
  const digests = await loadDigests();
  return digests.map((d) => ({
    params: { slug: d.slug },
    props: { digest: d }
  }));
};

export const prerender = true;

const props = Astro.props as { digest?: any };
let digest = props.digest;
if (!digest) {
  const slug = Astro.params.slug;
  digest = digests.find((d) => d.slug === slug);
}
if (!digest) {
  Astro.response.status = 404;
}
---
<BaseLayout title={`${digest.title}`} description={`Digest No. ${digest.number} – ${digest.date}`}>
  <article class="mx-auto max-w-3xl">
    <h1 class="text-3xl sm:text-4xl font-semibold">{digest.title}</h1>
    <p class="text-sm text-slate-500">
      No. {digest.number} · <time datetime={digest.date}>{digest.date}</time> · By {digest.authorUrl ? (
        <a href={digest.authorUrl} target="_blank" rel="noopener noreferrer" class="text-slate-700 hover:text-sky-700 hover:underline inline-flex items-center gap-1">
          {digest.author}
          <svg class="w-3 h-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </a>
      ) : (
        <span>{digest.author}</span>
      )}
    </p>

    {digest.summary && (
      <p class="mt-6 text-lg leading-relaxed text-slate-700">{digest.summary}</p>
    )}

    {digest.content && (
      <div class="mt-8 text-slate-800" set:html={renderSimpleMarkdown(digest.content)} />
    )}

    {digest.entries && digest.entries.length > 0 && (
      <section class="mt-12">
        <h2 class="text-2xl font-semibold">References</h2>
        <ul class="mt-4 divide-y divide-slate-200">
          {digest.entries.map((e) => (
            <li class="py-4">
              <div class="flex flex-col gap-2">
                <a href={e.url} target="_blank" rel="noopener noreferrer" class="font-medium text-slate-900 hover:text-sky-700 hover:underline">
                  {e.title || e.url}
                </a>
              </div>
              {e.summary && (
                <div class="text-sm text-slate-600 mt-2 leading-relaxed">{e.summary}</div>
              )}
              {e.tags && e.tags.length > 0 && (
                <div class="mt-2 text-xs text-slate-500">
                  {e.tags.map((t) => (
                    <span class="mr-2">#{t}</span>
                  ))}
                </div>
              )}
            </li>
          ))}
        </ul>
      </section>
    )}
  </article>
</BaseLayout>


